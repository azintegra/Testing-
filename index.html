<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Flex Gate & Locker Codes</title>
<style>
:root{
  --bg:#000;
  --surface:#0f0f18;
  --text:#f5f5f7;
  --sub:#9ca3af;
  --accent:#3b82f6;
  --danger:#ef4444;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  color:var(--text);
  background:radial-gradient(circle at top,#111 0%,#000 65%);
  -webkit-font-smoothing:antialiased;
  padding-bottom:40px;
}

header{
  position:sticky;
  top:0;
  backdrop-filter:blur(20px);
  background:rgba(0,0,0,0.75);
  padding:18px 16px 14px;
  border-bottom:1px solid rgba(255,255,255,0.05);
  z-index:100;
}

h1{
  font-size:26px;
  font-weight:700;
  margin-bottom:6px;
}

#buildInfo{
  color:#6b7280;
  font-size:12px;
  margin-bottom:12px;
  min-height:16px;
}

.search input{
  width:100%;
  padding:14px 16px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(255,255,255,0.05);
  color:white;
  font-size:15px;
}

.filters{
  display:flex;
  gap:10px;
  margin-top:14px;
}

.filter-btn{
  padding:9px 18px;
  border-radius:999px;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.05);
  color:white;
  font-size:13px;
  transition:all .15s ease;
  cursor:pointer;
}

.filter-btn.active{
  background:var(--accent);
  border-color:var(--accent);
}

.group{
  margin:16px;
  border-radius:18px;
  background:linear-gradient(145deg,#0f0f18,#0a0a12);
  border:1px solid rgba(255,255,255,0.05);
  box-shadow:0 10px 30px rgba(0,0,0,.5);
  overflow:hidden;
  animation:fadeIn .25s ease;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:translateY(0)}
}

.group-header{
  padding:16px 20px;
  font-weight:650;
  font-size:15px;
  background:rgba(255,255,255,0.03);
  display:flex;
  justify-content:space-between;
}

.entry{
  padding:16px 20px;
  border-top:1px solid rgba(255,255,255,0.05);
}

.address{
  font-size:16px;
  font-weight:650;
  margin-bottom:6px;
}

.location{
  font-size:13px;
  color:var(--sub);
  margin-bottom:12px;
}

.tags{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

.tag{
  padding:8px 14px;
  border-radius:999px;
  font-size:12px;
  cursor:pointer;
  transition:transform .12s ease, background .12s ease, border-color .12s ease;
  user-select:none;
}

.tag:active{ transform:scale(.97); }

.tag.gate{
  background:rgba(59,130,246,.22);
  border:1px solid rgba(59,130,246,.25);
  color:#93c5fd;
}

.tag.gate.more{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  color:var(--sub);
}

.tag.gate.missing{
  background:rgba(239,68,68,.18);
  border:1px solid rgba(239,68,68,.25);
  color:#fca5a5;
  cursor:default;
}

.tag.type{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  color:var(--sub);
  cursor:default;
}

.tag.street{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.10);
}

</style>
</head>

<body>
<header>
  <h1>Flex Gate & Locker Codes</h1>
  <div id="buildInfo">Build v9 • loading…</div>

  <div class="search">
    <input id="q" placeholder="Search address, community, gate"/>
  </div>

  <div class="filters">
    <button class="filter-btn active" data-type="All">All</button>
    <button class="filter-btn" data-type="Apartments">Apartments</button>
    <button class="filter-btn" data-type="Residential">Residential</button>
    <button class="filter-btn" data-type="Businesses">Businesses</button>
  </div>
</header>

<main id="list"></main>

<script>
let DATA = {};
let currentType = "All";

const DATA_VERSION = "v9";
const PROJECT_FALLBACK = "Testing-"; // change if your repo name changes
const qInput = document.getElementById("q");
const list = document.getElementById("list");

function setBuildInfo(msg){
  const el = document.getElementById("buildInfo");
  if (el) el.textContent = msg;
}

window.addEventListener("error", (e) => {
  setBuildInfo(`Build ${DATA_VERSION} • JS error: ${e.message || "unknown"}`);
});
window.addEventListener("unhandledrejection", () => {
  setBuildInfo(`Build ${DATA_VERSION} • Promise error`);
});

function openMap(encoded){
  const app = `comgooglemaps://?q=${encoded}`;
  const web = `https://www.google.com/maps/search/?api=1&query=${encoded}`;
  window.location = app;
  setTimeout(() => { window.location = web; }, 600);
}

function extractGateTokens(raw){
  const s = String(raw ?? "");
  const tokens = s.match(/\d+/g) || [];
  const out = [];
  const seen = new Set();
  for (const t of tokens){
    if (!seen.has(t)){
      seen.add(t);
      out.push(t);
    }
  }
  return out;
}

function renderGateTags(tokens, maxShown){
  if (!tokens || !tokens.length){
    return `<span class="tag gate missing">No gate codes listed</span>`;
  }
  const shown = tokens.slice(0, maxShown);
  const hidden = tokens.slice(maxShown);
  const chips = shown.map(t => `<span class="tag gate">#${t}</span>`).join("");
  if (!hidden.length) return chips;
  const label = `+${hidden.length} more`;
  return chips + `<span class="tag gate more" title="${hidden.join(" ")}">${label}</span>`;
}

function normalizeLoadedData(raw){
  const groups = raw && raw.groups ? raw.groups : raw;
  const normalized = {};
  for (const [community, entries] of Object.entries(groups || {})){
    normalized[community] = (entries || []).map(e => {
      const gate =
        e.gate ?? e.Gate ?? e["gate code"] ?? e["Gate Code"] ??
        e.up_pass ?? e.upPass ?? e["up pass"] ?? e["Up Pass"] ?? e["UP PASS"] ??
        e.code ?? e.Code ?? "";
      const type = e.type ?? e.Type ?? e["community type"] ?? e["Community Type"] ?? "";
      return { ...e, gate: String(gate ?? "").trim(), type: String(type ?? "").trim() };
    });
  }
  return normalized;
}

function render(){
  const query = qInput.value.toLowerCase().trim();

  const html = Object.entries(DATA).map(([community, entries]) => {
    const filtered = (entries || []).filter(e => {
      const typeMatch = currentType === "All" || (e.type || "") === currentType;
      if (!typeMatch) return false;
      if (!query) return true;

      const gates = (e._gateTokens || extractGateTokens(e.gate)).join(" ");
      return (
        String(e.address || "").toLowerCase().includes(query) ||
        String(community || "").toLowerCase().includes(query) ||
        String(e.gate || "").toLowerCase().includes(query) ||
        gates.includes(query)
      );
    });

    if (!filtered.length) return "";

    return `
      <div class="group">
        <div class="group-header">
          ${community}
          <span>(${filtered.length})</span>
        </div>

        ${filtered.map(e => {
          const addr = String(e.address || "").trim();
          const gateTokens = e._gateTokens || extractGateTokens(e.gate);
          return `
            <div class="entry">
              <div class="address">${addr || community}</div>
              <div class="location">${community} • ${e.type || "Unknown"}</div>
              <div class="tags">
                ${renderGateTags(gateTokens, 8)}
                <span class="tag type">${e.type || "Unknown"}</span>
                <span class="tag street" onclick="openMap('${encodeURIComponent((addr||community)+', '+community+', Tucson, AZ')}')">
                  Street View
                </span>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }).join("");

  list.innerHTML = html || "<div style='padding:60px;text-align:center;color:#666;'>No results</div>";
}

qInput.addEventListener("input", render);

document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentType = btn.dataset.type;
    render();
  });
});

function candidatesForCurrentLocation(){
  const here = new URL(window.location.href);
  const basePath = here.pathname.endsWith("/") ? here.pathname : here.pathname.replace(/\/[^\/]*$/, "/");

  const isGithubUserSite = here.hostname.endsWith(".github.io") && basePath === "/";
  const projectBase = isGithubUserSite ? `/${PROJECT_FALLBACK}/` : basePath;

  // Try both spellings because mobile uploads often end up renamed.
  const names = ["data.cleaned.json", "data.cleaned.json", "data.json"];

  const bases = [];
  // 1) same directory as index.html
  bases.push(basePath);
  // 2) if user opened root but data is in project path
  if (isGithubUserSite) bases.push(projectBase);

  const out = [];
  for (const b of bases){
    for (const n of names){
      out.push(new URL(n, here.origin + b).toString());
    }
  }
  // De-dupe
  return Array.from(new Set(out));
}

async function loadData(){
  const candidates = candidatesForCurrentLocation();
  for (const url of candidates){
    try{
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(String(r.status));
      const data = await r.json();
      DATA = normalizeLoadedData(data);

      const groupCount = Object.keys(DATA || {}).length;
      const entryCount = Object.values(DATA || {}).reduce((a, arr) => a + (arr?.length || 0), 0);

      let sample = "";
      for (const arr of Object.values(DATA || {})){
        for (const e of (arr || [])){
          const gt = extractGateTokens(e.gate);
          if (gt.length){ sample = gt[0]; break; }
        }
        if (sample) break;
      }

      setBuildInfo(`Build ${DATA_VERSION} • loaded • ${groupCount} groups • ${entryCount} entries${sample ? " • sample #" + sample : " • no gates found"}`);
      render();
      return;
    }catch(err){
      // keep trying
    }
  }

  setBuildInfo(`Build ${DATA_VERSION} • failed to load data.json`);
  list.innerHTML = "<div style='padding:60px;text-align:center;color:#666;'>Failed to load data.json</div>";
}

loadData();
</script>
</body>
</html>
